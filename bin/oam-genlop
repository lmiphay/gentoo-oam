#!/bin/bash

source /etc/gentoo-oam.conf
source /usr/share/gentoo-oam/gentoo-oam-functions.sh

oam_genlop_filter()
{
    read empty
    read currently merging num out of total
    read empty
    read start package
    read empty
    read current merge time runtime
    read eta estimatetime

    if [[ "$currently" = "Currently" ]] ; then
	echo -e "$(oam_ts) $num/$total pkgs\n  $package \n  Gone: $runtime \n  Left: $estimatetime" | \
	    sed -e 's/minutes/min/g;s/seconds./sec/g;s/hour/hr/g;s/ and / /g'
    fi
}

oam_genlop_short()
{
    genlop --nocolor --current | oam_genlop_filter
}

oam_genlop_tail()
{
    while /bin/true; do
	inotifywait --timeout $OAM_HEARTBEATSLEEP --quiet --event modify /var/log/emerge.log >/dev/null
	case "$?" in
            0)
		for ((t=0; $t<$OAM_SANDBOXWAIT; t++)); do
		    if [[ -n "$(pgrep sandbox)" ]] ; then
			oam_genlop_short
			break
		    fi
		    sleep 1
		done
		;&
	    2)
		oam_uptime
		;;
	    1)
		echo "$(oam_ts) /var/log/emerge.log was removed"
		;;
	    *)
		echo "$(oam_ts) inotifywait exited with $?"
		;;
	esac
    done
}

if [[ "$1" = "tail" ]] ; then
    oam_genlop_tail
else
    oam_genlop_short
fi

exit 0
