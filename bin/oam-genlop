#!/bin/bash

source /etc/gentoo-oam.conf
source /usr/share/gentoo-oam/gentoo-oam-functions.sh

oam_genlop_filter()
{
    read empty
    read currently merging num out of total
    read empty
    read start package
    read empty
    read current merge time runtime
    read eta estimatetime

    if [[ "$currently" = "Currently" ]] ; then
	echo -e "$(oam_ts) $num/$total pkgs\n  $package \n  Gone: $runtime \n  Left: $estimatetime" | \
	    sed -e 's/minutes/min/g;s/seconds./sec/g;s/hour/hr/g;s/ and / /g'
    fi
}

oam_genlop_short()
{
    genlop --nocolor --current | oam_genlop_filter
}

oam_genlog_tmpdir()
{
    emerge --verbose --info | egrep '^PORTAGE_TMPDIR=' | sed -e 's/^.*=//' -e 's/"//g'
}

oam_genlop_df()
{
    df -$1 $2 | tail -1 | awk '{print $5}' | sed -e 's/%//'
}

oam_genlop_used()
{
    echo "$(oam_genlop_df h $1)%d $(oam_genlop_df hi $1)%i"
}

oam_genlop_tail()
{
    local t
    local portage_tmpdir=$(oam_genlog_tmpdir)
    
    while /bin/true; do
	inotifywait --timeout $OAM_HEARTBEATSLEEP --quiet --event modify /var/log/emerge.log >/dev/null
	case "$?" in
            0)
		for ((t=0; $t<$OAM_SANDBOXWAIT; t++)); do
		    if [[ -n "$(pgrep sandbox)" ]] ; then
			oam_genlop_short
			break
		    fi
		    sleep 1
		done
		;&
	    2)
		echo "$(oam_uptime)$(oam_genlop_used)"
		;;
	    1)
		echo "$(oam_ts) /var/log/emerge.log was removed"
		;;
	    *)
		echo "$(oam_ts) inotifywait exited with $?"
		;;
	esac
    done
}

if [[ "$1" = "tail" ]] ; then
    oam_genlop_tail
elif [[ "$1" = "status" ]] ; then
    oam_uptime
    echo "                  $(oam_genlop_used)"
else
    oam_genlop_short
fi

exit 0
