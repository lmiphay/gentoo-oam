#!/bin/bash

OAM_ROW1_HEIGHT=9
OAM_ROW2_HEIGHT=9

source /etc/gentoo-oam.conf
source /usr/share/gentoo-oam/gentoo-oam-functions.sh

cd $OAM_LOGDIR || oam_die "$OAM_LOGDIR is missing - exiting"

watch_dir=$(oam_lastdate)

if [[ -f /etc/make.conf ]] ; then
    makeconf=/etc/make.conf
elif [[ -f /etc/portage/make.conf ]] ; then
    makeconf=/etc/portage/make.conf
fi

watch_allfiles=$(echo \
	oam.log \
	error.log \
	$watch_dir/{blocks,glsa,kernel,merge,summary,sync}.log \
	/etc/portage/package.{keywords,use} \
	$makeconf)

# these are needed by the helper programs run from multitail
export OAM_EDITOR OAM_EDITOR_MULTITAB OAM_LOGDIR OAM_TERMINAL watch_dir watch_allfiles
export PATH=/usr/sbin:$PATH

oam-genlop tail | \
    multitail \
	  -x "$HOSTNAME/oam/$watch_dir/$(uname -r) gentoo-oam V$(oam_version)" \
	  --config /usr/share/gentoo-oam/gentoo-oam-multitail.conf \
	  --basename \
	  -sw 45,40 -sn 3,4 \
	  \
	  -wh ${OAM_ROW1_HEIGHT} /usr/share/gentoo-oam/oam-watch.help \
	  --retry -wh ${OAM_ROW2_HEIGHT} $watch_dir/oam.log \
	  -j \
	  \
	  -wh ${OAM_ROW1_HEIGHT} -l "oam emergelog" \
	  --retry-all \
	  -wh ${OAM_ROW2_HEIGHT} $watch_dir/error.log \
	  --mark-change -T \
	  -i $watch_dir/sync.log \
	  -I $watch_dir/merge.log \
	  --label "blocks " -I $watch_dir/blocks.log \
	  -t "sync/merge/blocks/kernel " \
	  -I $watch_dir/kernel.log \
	  -I $watch_dir/summary.log \
	  $OAM_MULTITAIL_EXTRA_OPT

exit 0
