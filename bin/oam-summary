#!/bin/bash

source /etc/gentoo-oam.conf
source /usr/share/gentoo-oam/gentoo-oam-functions.sh

cd $OAM_LOGDIR || oam_die "$OAM_LOGDIR is missing - exiting"

if [[ $# -eq 1 ]] ; then
    LOGDATE=$1
else
    LOGDATE=$(ls -1dt 2* | head -1)
fi

echo "$(oam_ts) summary report for $LOGDATE"

mergelog=$LOGDATE/merge.log
blockslog=$LOGDATE/blocks.log

echo "$(oam_ts) merges"
while read firsttoken line ; do
    if [[ "$firsttoken" = '[ebuild' ]] ; then
	while read firsttoken line ; do
	    if [[ "$firsttoken" = 'Total:' ]] ; then
		break 2
	    else
		echo "$firsttoken $line" | oam_indent
	    fi
	done
    fi
done <$mergelog

if [[ -f $blockslog ]] ; then
    echo "$(oam_ts) errors/blocked packages"
    cat $blockslog | oam_indent
fi

PREVDATE=$(oam_prevdate $LOGDATE)
echo "$(oam_ts) checking for qcheck differences"
if [[ -f $LOGDATE/qcheck.log -a $PREVDATE/qcheck.log ]] ; then
    diff -u $PREVDATE/qcheck.log $LOGDATE/qcheck.log | oam_indent
fi

echo "$(oam_ts) checking for unread news items"
oam_checknews | oam_indent

echo "$(oam_ts) merges: $(grep 'Size of downloads:' $mergelog | head -1)"

if [[ -f $blockslog ]] ; then
    echo "$(oam_ts) keyword/use changes"
    egrep '^>|^=' $blockslog | sort | uniq | oam_indent
fi

echo "$(oam_ts) summary report complete for $LOGDATE"

exit 0
