#!/bin/bash

source /etc/gentoo-oam.conf
source /usr/share/gentoo-oam/gentoo-oam-functions.sh

cd $OAM_LOGDIR || oam_die "$OAM_LOGDIR is missing - exiting"

if [[ $# -eq 1 ]] ; then
    LOGDATE=$1
else
    LOGDATE=$(ls -1dt 2* | head -1)
fi

echo "$(oam_ts) summary report for $LOGDATE"

mergelog=$LOGDATE/merge.log
blockslog=$LOGDATE/blocks.log

echo "$(oam_ts) merges"
while read firsttoken line ; do
    if [[ "$firsttoken" = '[ebuild' ]] ; then
	while read firsttoken line ; do
	    if [[ "$firsttoken" = 'Total:' ]] ; then
		break 2
	    else
		echo "$firsttoken $line" | sed -e 's/^/   /'
	    fi
	done
    fi
done <$mergelog

if [[ -f $blockslog ]] ; then
    echo "$(oam_ts) errors/blocked packages"
    cat $blockslog | sed -e 's/^/   /'
fi

echo "$(oam_ts) checking for new news items"
oam-checknews | sed -e 's/^/   /'

echo "$(oam_ts) merges: $(grep 'Size of downloads:' $mergelog | head -1)"

if [[ -f $blockslog ]] ; then
    echo "$(oam_ts) keyword/use changes"
    egrep '^>|^=' $blockslog | sort | uniq | sed -e 's/^/   /'
fi

echo "$(oam_ts) summary report complete for $LOGDATE"

exit 0
